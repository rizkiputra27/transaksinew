<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Laporan Transaksi Gabungan</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
    h2 { background: #2196F3; color: white; padding: 10px; }
    .tab { display: none; }
    .tab.active { display: block; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tabs button { padding: 10px 20px; cursor: pointer; border: none; background: #ccc; }
    .tabs button.active { background: #2196F3; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    .btn-export { margin-top: 20px; padding: 10px 20px; background: #4CAF50; color: white; border: none; cursor: pointer; }
  </style>
</head>
<body>

<h2>Laporan Transaksi Gabungan</h2>

<div class="tabs">
  <button onclick="showTab('pulsa')" class="active">Pulsa</button>
  <button onclick="showTab('tf')">TF</button>
  <button onclick="showTab('tarik')">Tarik Tunai</button>
</div>

<div id="pulsa" class="tab active">
  <h3>Penjualan Pulsa</h3>
  <table id="tablePulsa">
    <thead>
      <tr><th>No</th><th>Tanggal</th><th>No HP</th><th>Denom</th><th>Harga Jual</th><th>Modal</th><th>Laba</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="tf" class="tab">
  <h3>Transaksi TF</h3>
  <table id="tableTF">
    <thead>
      <tr><th>No</th><th>Tanggal</th><th>Penyetor</th><th>Bank</th><th>Nominal</th><th>Fee Admin</th><th>Total</th><th>Margin</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="tarik" class="tab">
  <h3>Tarik Tunai</h3>
  <table id="tableTarik">
    <thead>
      <tr><th>No</th><th>Tanggal</th><th>Keterangan</th><th>Nominal</th><th>Admin</th><th>Total</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<div id="modalEdit" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px;">
    <h3>Edit Transaksi</h3>
    <form id="formEdit">
      <input type="hidden" id="editIndex">
      <input type="hidden" id="editType">
      <div id="formEditFields"></div>
      <button type="submit">üíæ Simpan</button>
      <button type="button" onclick="closeModal()">‚ùå Batal</button>
    </form>
  </div>
</div>

<button class="btn-export" onclick="exportSemuaData()">üì§ Ekspor Semua ke Excel</button>

<script>
function showTab(id) {
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(id).classList.add('active');
}

function loadData() {
  // Pulsa
  const dataPulsa = JSON.parse(localStorage.getItem('pulsaData')) || [];
  const tbodyPulsa = document.querySelector('#tablePulsa tbody');
  tbodyPulsa.innerHTML = '';
  dataPulsa.forEach(d => {
    tbodyPulsa.innerHTML += `<tr>
      <td>${d.No}</td><td>${d.Tanggal}</td><td>${d["No HP"]}</td><td>${d.Denom}</td>
      <td>${d["Harga Jual"]}</td><td>${d.Modal}</td><td>${d.Laba}</td>
    </tr>`;
  });

  // TF
  const dataTF = JSON.parse(localStorage.getItem('tfData')) || [];
  const tbodyTF = document.querySelector('#tableTF tbody');
  tbodyTF.innerHTML = '';
  dataTF.forEach(d => {
    tbodyTF.innerHTML += `<tr>
      <td>${d.No}</td><td>${d.Tanggal}</td><td>${d["No HP"]}</td><td>${d.Bank}</td>
      <td>${d.Nominal}</td><td>${d["Fee Admin"]}</td><td>${d.Total}</td><td>${d.Margin}</td>
    </tr>`;
  });

  // Tarik Tunai
  const dataTarik = JSON.parse(localStorage.getItem('tarikData')) || [];
  const tbodyTarik = document.querySelector('#tableTarik tbody');
  tbodyTarik.innerHTML = '';
  dataTarik.forEach(d => {
    tbodyTarik.innerHTML += `<tr>
      <td>${d.No}</td><td>${d.Tanggal}</td><td>${d.Keterangan || ''}</td>
      <td>${d.Nominal}</td><td>${d.Admin}</td><td>${d.Total}</td>
    </tr>`;
  });
}

function exportSemuaData() {
  const wb = XLSX.utils.book_new();

  const dataPulsa = JSON.parse(localStorage.getItem('pulsaData')) || [];
  const dataTF = JSON.parse(localStorage.getItem('tfData')) || [];
  const dataTarik = JSON.parse(localStorage.getItem('tarikData')) || [];

  // Pulsa Sheet
  const pulsaSheet = dataPulsa.map(d => [d.No, d.Tanggal, d["No HP"], d.Denom, d["Harga Jual"], d.Modal, d.Laba]);
  const rowPulsa = pulsaSheet.length + 1;
  pulsaSheet.unshift(["No", "Tanggal", "No HP", "Denom", "Harga Jual", "Modal", "Laba"]);
  pulsaSheet.push(["Total", "", "", "", { f: `SUM(E2:E${rowPulsa})` }, "", { f: `SUM(G2:G${rowPulsa})` }]);
  const wsPulsa = XLSX.utils.aoa_to_sheet(pulsaSheet);
  XLSX.utils.book_append_sheet(wb, wsPulsa, 'Penjualan Pulsa');

  // TF Sheet
  const tfSheet = dataTF.map(d => [d.No, d.Tanggal, d["No HP"], d.Bank, d.Nominal, d["Fee Admin"], d.Total, d.Margin]);
  const rowTF = tfSheet.length + 1;
  tfSheet.unshift(["No", "Tanggal", "Penyetor", "Bank", "Nominal", "Fee Admin", "Total", "Margin"]);
  tfSheet.push(["Total", "", "", "", { f: `SUM(E2:E${rowTF})` }, { f: `SUM(F2:F${rowTF})` }, { f: `SUM(G2:G${rowTF})` }, { f: `SUM(H2:H${rowTF})` }]);
  const wsTF = XLSX.utils.aoa_to_sheet(tfSheet);
  XLSX.utils.book_append_sheet(wb, wsTF, 'Transaksi TF');

  // Tarik Tunai Sheet
  const tarikSheet = dataTarik.map(d => [d.No, d.Tanggal, d.Keterangan || '', d.Nominal, d.Admin, d.Total]);
  const rowTarik = tarikSheet.length + 1;
  tarikSheet.unshift(["No", "Tanggal", "Keterangan", "Nominal", "Admin", "Total"]);
  tarikSheet.push(["Total", "", "", { f: `SUM(D2:D${rowTarik})` }, { f: `SUM(E2:E${rowTarik})` }, { f: `SUM(F2:F${rowTarik})` }]);
  const wsTarik = XLSX.utils.aoa_to_sheet(tarikSheet);
  XLSX.utils.book_append_sheet(wb, wsTarik, 'Tarik Tunai');

  XLSX.writeFile(wb, 'Laporan_Transaksi_Gabungan.xlsx');
}

window.onload = loadData;
</script>

</body>
</html>
